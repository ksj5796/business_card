<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>명함 제작 프로그램 - 작동 보장 단일 파일</title>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- html2canvas (이미지로 캡처) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <!-- 한글 폰트 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard-dynamic-subset.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=Noto+Serif+KR:wght@400;600;700&family=Black+Han+Sans&display=swap">
  <style>
    html, body { height: 100%; }
    * { -webkit-tap-highlight-color: transparent; }
    .card { width: 336px; height: 192px; }
    @media (max-width: 420px){ .card { transform: scale(0.95); transform-origin: top center; } }
  </style>
</head>
<body class="bg-slate-50">
  <div class="min-h-screen p-3 sm:p-6">
    <div class="mx-auto max-w-6xl grid grid-cols-1 lg:grid-cols-[minmax(0,460px),1fr] gap-4 sm:gap-6">
      <!-- 좌측: 입력 패널 -->
      <div class="bg-white rounded-2xl shadow p-4 sm:p-5">
        <div class="flex items-center justify-between mb-3">
          <h1 class="text-lg sm:text-xl font-semibold">명함 제작 프로그램</h1>
          <button id="resetBtn" class="text-xs px-3 py-1.5 rounded-full bg-slate-100 hover:bg-slate-200">초기화</button>
        </div>
        <div class="space-y-2">
          <input id="name" class="w-full border rounded p-2" placeholder="이름" />
          <input id="title" class="w-full border rounded p-2" placeholder="직책" />
          <input id="phone" class="w-full border rounded p-2" placeholder="전화번호" />
          <input id="email" class="w-full border rounded p-2" placeholder="이메일" />
          <input id="website" class="w-full border rounded p-2" placeholder="웹사이트" />
          <input id="address" class="w-full border rounded p-2" placeholder="주소" />

          <div class="grid grid-cols-2 gap-3 mt-1">
            <label class="text-sm text-slate-600">배경색
              <input id="bgColor" type="color" class="w-full h-10 rounded border border-slate-200 cursor-pointer" />
            </label>
            <label class="text-sm text-slate-600">글자 색상
              <input id="textColor" type="color" class="w-full h-10 rounded border border-slate-200 cursor-pointer" />
            </label>
          </div>

          <label class="text-sm text-slate-600">폰트 (한글)
            <select id="fontFamily" class="w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-sky-400 shadow-sm">
              <option value="'Pretendard Variable','Noto Sans KR',system-ui,sans-serif">Pretendard</option>
              <option value="'Noto Sans KR',system-ui,sans-serif">Noto Sans KR</option>
              <option value="'Noto Serif KR',serif">Noto Serif KR</option>
              <option value="'Black Han Sans','Noto Sans KR',sans-serif">Black Han Sans</option>
            </select>
          </label>

          <label class="text-sm text-slate-600">로고 (오른쪽 상단)
            <input id="logoInput" type="file" accept="image/*" class="block w-full text-sm" />
            <span id="logoStatus" class="text-xs text-slate-500 hidden">업로드됨 ✓</span>
          </label>
        </div>

        <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-2">
          <button id="savePngPc" class="px-3 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 text-sm">PC: PNG 다운로드</button>
          <button id="saveJpgPc" class="px-3 py-2 rounded-xl bg-amber-600 text-white hover:bg-amber-700 text-sm">PC: JPG 다운로드</button>
          <button id="shareMobile" class="px-3 py-2 rounded-xl bg-slate-900 text-white hover:bg-black text-sm">모바일: 갤러리/공유</button>
        </div>
      </div>

      <!-- 우측: 미리보기 -->
      <div class="space-y-4">
        <div class="bg-white rounded-2xl shadow p-4 sm:p-5">
          <div class="flex items-center justify-between mb-3">
            <div>
              <div class="text-sm text-slate-600">라이브 미리보기</div>
              <div class="text-xs text-slate-500">크기: 336×192px (86×54mm 비율)</div>
            </div>
            <button id="printBtn" class="px-3 py-1.5 rounded-full bg-sky-600 text-white text-sm hover:bg-sky-700">인쇄 / PDF</button>
          </div>
          <div class="flex items-center justify-center">
            <div id="card" class="card relative rounded-2xl shadow-sm overflow-hidden">
              <!-- 로고 -->
              <img id="logoImg" alt="logo" class="absolute top-3 right-3 max-h-12 max-w-24 object-contain hidden" />
              <!-- 내용 -->
              <div class="absolute inset-4 flex flex-col items-center justify-center text-center leading-tight">
                <div id="nameOut" class="text-[20px] font-bold"></div>
                <div id="titleOut" class="text-[12px] mt-0.5 opacity-90"></div>
                <div class="mt-2 text-[11px] opacity-95 space-y-0.5">
                  <div id="phoneOut"></div>
                  <div id="emailOut"></div>
                  <div id="websiteOut"></div>
                  <div id="addressOut"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow p-4 sm:p-5">
          <h2 class="text-sm font-semibold mb-2">팁</h2>
          <ul class="list-disc pl-5 text-sm text-slate-600 space-y-1">
            <li>모바일은 <b>갤러리/공유</b> 버튼을 눌러 사진앱으로 저장하세요. (iOS: 공유 시 "이미지 저장")</li>
            <li>PC는 PNG/JPG 버튼으로 <b>다운로드 폴더</b>에 저장됩니다.</li>
            <li>글자 색상 선택은 모든 텍스트에 즉시 반영됩니다.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---- 상태 관리 (localStorage) ----
    const KEY = 'business_card_studio_fixed_v1';
    const state = JSON.parse(localStorage.getItem(KEY) || 'null') || {
      name: '홍길동',
      title: '대표 / 이사',
      phone: '010-1234-5678',
      email: 'hello@example.com',
      website: 'www.example.com',
      address: '서울특별시 강남구 테헤란로 123',
      bgColor: '#0ea5e9',
      textColor: '#111827',
      fontFamily: "'Pretendard Variable','Noto Sans KR',system-ui,sans-serif",
      logoDataUrl: ''
    };
    function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

    // ---- 엘리먼트 ----
    const el = (id) => document.getElementById(id);

    // inputs
    const nameIn = el('name');
    const titleIn = el('title');
    const phoneIn = el('phone');
    const emailIn = el('email');
    const websiteIn = el('website');
    const addressIn = el('address');
    const bgIn = el('bgColor');
    const txtIn = el('textColor');
    const fontIn = el('fontFamily');

    const logoInput = el('logoInput');
    const logoStatus = el('logoStatus');

    // outputs
    const card = el('card');
    const logoImg = el('logoImg');
    const nameOut = el('nameOut');
    const titleOut = el('titleOut');
    const phoneOut = el('phoneOut');
    const emailOut = el('emailOut');
    const websiteOut = el('websiteOut');
    const addressOut = el('addressOut');

    // 초기값 바인딩
    function bindInputs(){
      nameIn.value = state.name; titleIn.value = state.title; phoneIn.value = state.phone;
      emailIn.value = state.email; websiteIn.value = state.website; addressIn.value = state.address;
      bgIn.value = state.bgColor; txtIn.value = state.textColor; fontIn.value = state.fontFamily;
    }

    function render(){
      card.style.background = state.bgColor;
      card.style.color = state.textColor;
      card.style.fontFamily = state.fontFamily;
      nameOut.textContent = state.name || '이름';
      titleOut.textContent = state.title || '직책';
      phoneOut.textContent = state.phone; emailOut.textContent = state.email; websiteOut.textContent = state.website; addressOut.textContent = state.address;
      if(state.logoDataUrl){ logoImg.src = state.logoDataUrl; logoImg.classList.remove('hidden'); } else { logoImg.classList.add('hidden'); }
    }

    function attachEvents(){
      const sync = (key) => (e) => { state[key] = e.target.value; save(); render(); };
      nameIn.addEventListener('input', sync('name'));
      titleIn.addEventListener('input', sync('title'));
      phoneIn.addEventListener('input', sync('phone'));
      emailIn.addEventListener('input', sync('email'));
      websiteIn.addEventListener('input', sync('website'));
      addressIn.addEventListener('input', sync('address'));
      bgIn.addEventListener('input', sync('bgColor'));
      txtIn.addEventListener('input', sync('textColor'));
      fontIn.addEventListener('change', sync('fontFamily'));

      logoInput.addEventListener('change', (e)=>{
        const f = e.target.files && e.target.files[0];
        if(!f){ state.logoDataUrl=''; logoStatus.classList.add('hidden'); save(); return render(); }
        const reader = new FileReader();
        reader.onload = () => { state.logoDataUrl = String(reader.result); logoStatus.classList.remove('hidden'); save(); render(); };
        reader.readAsDataURL(f);
      });

      el('resetBtn').addEventListener('click', ()=>{ localStorage.removeItem(KEY); location.reload(); });

      // PC 저장
      const saveToPC = async (type='png') => {
        const canvas = await html2canvas(card, { backgroundColor: null, scale: 3 });
        canvas.toBlob((blob)=>{
          if(!blob) return;
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `${state.name||'card'}_${Date.now()}.` + (type==='jpg'?'jpg':type);
          a.click();
          setTimeout(()=> URL.revokeObjectURL(a.href), 10000);
        }, `image/${type==='jpg'?'jpeg':type}`);
      };
      el('savePngPc').addEventListener('click', ()=> saveToPC('png'));
      el('saveJpgPc').addEventListener('click', ()=> saveToPC('jpg'));

      // 모바일 갤러리/공유 (팝업 차단 회피: 모달 미리보기 폴백 포함)
      el('shareMobile').addEventListener('click', async ()=>{
        const canvas = await html2canvas(card, { backgroundColor: null, scale: 3 });
        canvas.toBlob(async (blob)=>{
          if(!blob) return;
          const fileName = `${state.name||'card'}.png`;
          const file = new File([blob], fileName, { type: 'image/png' });

          // 1) 가능하면 Web Share API 사용 (갤러리/사진앱 저장)
          if (navigator.canShare && navigator.canShare({ files:[file] })) {
            try { await navigator.share({ files:[file], title:'명함 저장', text:'명함 이미지를 저장합니다.' }); return; }
            catch(e) { /* 사용자 취소 등 무시 후 폴백 진행 */ }
          }

          // 2) 다운로드 링크 클릭 (일부 브라우저에서 파일앱으로 저장)
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = fileName; a.rel = 'noopener';
          document.body.appendChild(a); a.click(); document.body.removeChild(a);

          // 3) 같은 탭 모달 미리보기 → 길게 눌러 저장
          const overlay = document.createElement('div');
          overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;padding:16px;';
          const img = document.createElement('img');
          img.src = url; img.alt = 'export';
          img.style.cssText = 'max-width:92vw;max-height:70vh;border-radius:12px;background:white;';
          const tip = document.createElement('div');
          tip.textContent = '이미지를 길게 눌러 저장하세요 (닫기 버튼으로 돌아가기)';
          tip.style.cssText = 'color:white;margin-top:12px;font-size:14px;text-align:center;';
          const btn = document.createElement('button');
          btn.textContent = '닫기';
          btn.className = 'mt-3 px-3 py-2 rounded bg-white';
          btn.onclick = ()=> { document.body.removeChild(overlay); URL.revokeObjectURL(url); };
          overlay.appendChild(img); overlay.appendChild(tip); overlay.appendChild(btn);
          document.body.appendChild(overlay);
        }, 'image/png');
      });

      // 인쇄
      el('printBtn').addEventListener('click', async ()=>{
        const w = window.open('', 'printWin');
        if(!w) return;
        w.document.open();
        const html = `<!DOCTYPE html><html><head><meta charset='utf-8'><style>@page{size:86mm 54mm;margin:0}html,body{height:100%}body{display:grid;place-items:center;margin:0}</style></head><body>${card.outerHTML}</body></html>`;
        w.document.write(html);
        w.document.close();
        w.focus(); w.print();
      });
    }

    // init
    bindInputs(); render(); attachEvents();
  </script>
</body>
</html>
